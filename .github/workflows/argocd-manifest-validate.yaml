name: Verify Argo CD Manifests

on:
  pull_request:
    branches:
      - main # Or your default branch like 'master'
    # paths:
      # - 'argocd-manifests/' # Adjust this path to where your manifests are located

jobs:
  validate-manifests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Required for posting comments with datree

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Stage 1: Basic YAML and Kubernetes schema validation with Kubeconform
      - name: Validate with Kubeconform
        id: kubeconform-step
        uses: azure/k8s-lint@v3
        with:
          lintType: kubeconform
          manifests: 'apps//*.yaml' # Adjust to your manifest path
          kubeconformOpts: '-summary'
        continue-on-error: true
      
      # # Stage 2: Security and best practices check with kube-score
      # - name: Analyze with kube-score
      #   id: kube-score-step
      #   uses: zegl/kube-score-action@v2
      #   with:
      #     # Assumes you render your manifests here if using Helm/Kustomize.
      #     # Example for static manifests:
      #     score_cmd: 'kube-score score apps//*.yaml --output-format sarif'
      #   continue-on-error: true

      # # Stage 3: Policy enforcement and best practices with Datree
      # # A free account and DATREE_TOKEN is required for this step.
      # - name: Enforce policies with Datree
      #   if: success() || failure()
      #   uses: datreeio/action-datree@main
      #   with:
      #     path: 'apps//*.yaml'
      #     cliArguments: '--only-k8s-files'
      #   env:
      #     DATREE_TOKEN: ${{ secrets.DATREE_TOKEN }}
      #   continue-on-error: true

      # # Stage 4: Dry-run against a live cluster for advanced validation
      # - name: Perform Kubernetes server-side dry run
      #   id: kubectl-dry-run-step
      #   # This step requires your workflow to have access to a Kubernetes cluster.
      #   # This is not always recommended for PRs from untrusted users.
      #   if: false # Set to true to enable this check
      #   uses: azure/k8s-lint@v3
      #   with:
      #     lintType: dryrun
      #     manifests: 'apps//*.yaml'
      #   env:
      #     # Your KUBECONFIG secret with credentials for a validation cluster
      #     KUBECONFIG: ${{ secrets.KUBECONFIG }}
      #   continue-on-error: true

      # - name: Combine and summarize results
      #   run: |
      #     echo "## Argo CD Manifest Verification Report" >> $GITHUB_STEP_SUMMARY
      #     echo "### Kubeconform Results" >> $GITHUB_STEP_SUMMARY
      #     if [[ "${{ steps.kubeconform-step.outcome }}" == "success" ]]; then
      #       echo ":white_check_mark: Schema validation passed." >> $GITHUB_STEP_SUMMARY
      #     else
      #       echo ":x: Schema validation failed." >> $GITHUB_STEP_SUMMARY
      #       echo "See the logs for details." >> $GITHUB_STEP_SUMMARY
      #     fi
      #     echo "### Kube-score Results" >> $GITHUB_STEP_SUMMARY
      #     if [[ "${{ steps.kube-score-step.outcome }}" == "success" ]]; then
      #       echo ":white_check_mark: Best practices check passed." >> $GITHUB_STEP_SUMMARY
      #     else
      #       echo ":warning: Best practices check identified issues." >> $GITHUB_STEP_SUMMARY
      #       echo "See the logs for details." >> $GITHUB_STEP_SUMMARY
      #     fi
